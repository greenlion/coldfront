--disable_query_log
eval INSTALL PLUGIN rapid SONAME 'ha_rapid.so';
--enable_query_log

--echo #
--echo # Test RAPID binlog-based incremental replication
--echo #

--echo # Create and load a table
CREATE TABLE t1 (a INT, b VARCHAR(100)) SECONDARY_ENGINE RAPID;
INSERT INTO t1 VALUES (1, 'foo'), (2, 'bar');
ALTER TABLE t1 SECONDARY_LOAD;

SET SESSION secondary_engine_cost_threshold = 0;

--echo # Initial query
SELECT COUNT(*) FROM t1;

--echo # Insert more rows (should be replicated via binlog)
INSERT INTO t1 VALUES (3, 'baz'), (4, 'qux');

--echo # Give binlog consumer time to process
--sleep 2

--echo # Query again - should see new rows
SELECT COUNT(*) FROM t1;
SELECT * FROM t1 ORDER BY a;

--echo # Update a row
UPDATE t1 SET b = 'updated' WHERE a = 2;
--sleep 1
SELECT * FROM t1 WHERE a = 2;

--echo # Delete a row
DELETE FROM t1 WHERE a = 1;
--sleep 1
SELECT COUNT(*) FROM t1;

DROP TABLE t1;

--disable_query_log
UNINSTALL PLUGIN rapid;
--enable_query_log
